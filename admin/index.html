<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buy Junk Car Miami - Admin Panel</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            color: #1f2937;
        }

        .admin-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 280px;
            background: #1f2937;
            color: white;
            padding: 2rem 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .logo {
            padding: 0 2rem 2rem;
            border-bottom: 1px solid #374151;
            margin-bottom: 2rem;
        }

        .logo h1 {
            font-size: 1.4rem;
            color: #10b981;
        }

        .nav-item {
            padding: 1rem 2rem;
            cursor: pointer;
            border-left: 4px solid transparent;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }

        .nav-item:hover {
            background: #374151;
            border-left-color: #10b981;
        }

        .nav-item.active {
            background: #374151;
            border-left-color: #10b981;
            color: #10b981;
        }

        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 2rem;
        }

        .header {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-left: 4px solid #10b981;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #10b981;
        }

        .content-section {
            display: none;
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .content-section.active {
            display: block;
        }

        .section-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #10b981;
            color: white;
        }

        .btn-primary:hover {
            background: #059669;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            text-align: left;
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }

        th {
            background: #f9fafb;
            font-weight: 600;
        }

        .priority-high {
            background: #fee2e2;
            color: #b91c1c;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .priority-medium {
            background: #fef3c7;
            color: #a16207;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .priority-low {
            background: #e5e7eb;
            color: #4b5563;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-new {
            background: #dbeafe;
            color: #1d4ed8;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 2rem;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 1rem;
        }

        .form-control:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        textarea.form-control {
            height: 100px;
            resize: vertical;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
        }

        .refresh-btn {
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 4px;
        }

        .refresh-btn:hover {
            background: #f3f4f6;
        }
        
        .help-text {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.25rem;
            display: block;
        }
        
        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }
        
        /* Mobile Menu Toggle */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 1001;
            background: #1f2937;
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .mobile-menu-toggle i {
            font-size: 1.5rem;
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                z-index: 1000;
            }
            
            .sidebar.mobile-open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
                padding: 1rem;
                padding-top: 4rem;
            }
            
            .mobile-menu-toggle {
                display: block;
            }
            
            .header {
                padding: 1rem;
            }
            
            .header h2 {
                font-size: 1.2rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
            
            .stat-card {
                padding: 1rem;
            }
            
            .stat-number {
                font-size: 1.5rem;
            }
            
            table {
                font-size: 0.875rem;
            }
            
            th, td {
                padding: 0.75rem 0.5rem;
            }
            
            .modal-content {
                width: 95%;
                margin: 2rem auto;
                padding: 1.5rem;
            }
        }
        
        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .main-content {
                padding: 0.5rem;
                padding-top: 4rem;
            }
        }
        
        /* Login Screen */
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .login-container {
            background: white;
            padding: 3rem;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 400px;
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .login-header h1 {
            font-size: 1.8rem;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }
        
        .login-header p {
            color: #6b7280;
        }
    </style>
</head>
<body>
    <!-- Login Screen - SHOWN BY DEFAULT -->
    <div id="loginScreen" class="login-screen" style="display: flex;">
        <div class="login-container">
            <div class="login-header">
                <i class="fas fa-car" style="font-size: 3rem; color: #10b981; margin-bottom: 1rem;"></i>
                <h1>Admin Login</h1>
                <p>Buy Junk Car Miami</p>
            </div>
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="username" class="form-control" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="password" class="form-control" required autocomplete="current-password">
                </div>
                <div id="loginError" style="color: #dc2626; margin-bottom: 1rem; display: none;"></div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
            </form>
            <div style="margin-top: 1.5rem; text-align: center; font-size: 0.875rem; color: #6b7280;">
                <p>Default credentials:</p>
                <p><strong>Username:</strong> admin</p>
                <p><strong>Password:</strong> Miami2024!</p>
            </div>
        </div>
    </div>
    
    <button class="mobile-menu-toggle" onclick="toggleMobileMenu()" aria-label="Toggle menu" style="display: none;">
        <i class="fas fa-bars"></i>
    </button>
    
    <div class="admin-container" id="adminPanel" style="display: none;">
        <div class="sidebar" id="sidebar">
            <div class="logo">
                <h1><i class="fas fa-car"></i> Admin Panel</h1>
            </div>
            <div class="nav-item active" data-section="dashboard">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </div>
            <div class="nav-item" data-section="leads">
                <i class="fas fa-users"></i> Leads Management
            </div>
            <div class="nav-item" data-section="content">
                <i class="fas fa-edit"></i> Website Content
            </div>
            <div class="nav-item" data-section="images">
                <i class="fas fa-images"></i> Image Manager
            </div>
            <div class="nav-item" data-section="pages">
                <i class="fas fa-file-alt"></i> Create Pages
            </div>
            <div class="nav-item" data-section="business">
                <i class="fas fa-building"></i> Business Info
            </div>
        </div>

        <div class="main-content">
            <div class="header">
                <h2>Buy Junk Car Miami - Admin Dashboard</h2>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <button class="refresh-btn" onclick="refreshData()" title="Refresh data">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button class="btn btn-secondary" onclick="logout()" style="padding: 0.5rem 1rem;">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>

            <!-- Dashboard Section -->
            <div id="dashboard" class="content-section active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalLeads">-</div>
                        <div>Total Leads</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="newLeads">-</div>
                        <div>New Leads</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="todayLeads">-</div>
                        <div>Today's Leads</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="highPriorityLeads">-</div>
                        <div>High Priority</div>
                    </div>
                </div>
            </div>

            <!-- Leads Section -->
            <div id="leads" class="content-section">
                <div class="section-header">
                    <h3>Leads Management</h3>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-danger btn-sm" onclick="clearOldLeads()" title="Clear old localStorage leads">
                            <i class="fas fa-broom"></i> Clear Old Data
                        </button>
                        <button class="btn btn-primary" onclick="showAddLeadModal()">
                            <i class="fas fa-plus"></i> Add Lead
                        </button>
                    </div>
                </div>
                <div id="leadsTable">
                    <div class="loading">Loading leads...</div>
                </div>
            </div>

            <!-- Content Section -->
            <div id="content" class="content-section">
                <div class="section-header">
                    <h3>Website Content Management</h3>
                </div>
                <div id="contentEditor">
                    <div class="loading">Loading content...</div>
                </div>
            </div>

            <!-- Images Section -->
            <div id="images" class="content-section">
                <div class="section-header">
                    <h3>Image Manager</h3>
                    <button class="btn btn-primary">
                        <i class="fas fa-upload"></i> Upload Image
                    </button>
                </div>
                <div id="imagesGrid">
                    <div class="loading">Loading images...</div>
                </div>
            </div>

            <!-- Pages Section -->
            <div id="pages" class="content-section">
                <div class="section-header">
                    <h3>Create New Service Page</h3>
                </div>
                <div style="background: white; padding: 2rem; border-radius: 8px;">
                    <form id="createPageForm" onsubmit="createNewPage(event)">
                        <div class="form-group">
                            <label>Page Title *</label>
                            <input type="text" name="title" class="form-control" placeholder="e.g., Junk Car Removal in Hialeah" required>
                            <span class="help-text">This will be the H1 heading and page title</span>
                        </div>
                        
                        <div class="form-group">
                            <label>URL Slug *</label>
                            <input type="text" name="slug" class="form-control" placeholder="e.g., hialeah-junk-car-removal" required>
                            <span class="help-text">URL will be: /services/your-slug/</span>
                        </div>
                        
                        <div class="form-group">
                            <label>Meta Description *</label>
                            <textarea name="description" class="form-control" rows="3" placeholder="Brief description for search engines (150-160 characters)" required></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>Page Type</label>
                            <select name="pageType" class="form-control">
                                <option value="service">Service Page</option>
                                <option value="location">Location Page</option>
                                <option value="brand">Car Brand Page</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Main Content</label>
                            <textarea name="content" class="form-control" rows="8" placeholder="Main page content (HTML allowed)"></textarea>
                            <span class="help-text">You can use HTML tags for formatting</span>
                        </div>
                        
                        <div class="form-group">
                            <label>Phone Number</label>
                            <input type="tel" name="phone" class="form-control" value="(305) 534-5991">
                        </div>
                        
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Create Page
                        </button>
                    </form>
                    
                    <div id="pageCreationResult" style="margin-top: 1rem; display: none;"></div>
                </div>
            </div>

            <!-- Business Section -->
            <div id="business" class="content-section">
                <div class="section-header">
                    <h3>Business Information</h3>
                    <button class="btn btn-primary" onclick="saveBusinessInfo()">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
                <div id="businessForm">
                    <div class="loading">Loading business info...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Lead Modal -->
    <div id="addLeadModal" class="modal">
        <div class="modal-content">
            <h3>Add New Lead</h3>
            <form id="leadForm">
                <div class="form-group">
                    <label>Name *</label>
                    <input type="text" name="name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Phone *</label>
                    <input type="tel" name="phone" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" name="email" class="form-control">
                </div>
                <div class="form-group">
                    <label>Vehicle Year</label>
                    <input type="text" name="year" class="form-control">
                </div>
                <div class="form-group">
                    <label>Make</label>
                    <input type="text" name="make" class="form-control">
                </div>
                <div class="form-group">
                    <label>Model</label>
                    <input type="text" name="model" class="form-control">
                </div>
                <div class="form-group">
                    <label>Condition</label>
                    <select name="condition" class="form-control">
                        <option value="">Select condition</option>
                        <option value="excellent">Excellent</option>
                        <option value="good">Good</option>
                        <option value="fair">Fair</option>
                        <option value="poor">Poor</option>
                        <option value="junk">Junk/Scrap</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Location</label>
                    <input type="text" name="location" class="form-control" value="Miami">
                </div>
                <div class="form-group">
                    <label>Message</label>
                    <textarea name="message" class="form-control"></textarea>
                </div>
                <div style="margin-top: 1.5rem; text-align: right;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addLeadModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Lead</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Direct Supabase client - inline to avoid 403 errors
        const SUPABASE_URL = 'https://ccukjascbxmfbfalprib.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNjdWtqYXNjYnhtZmJmYWxwcmliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzODM2NzYsImV4cCI6MjA3ODk1OTY3Nn0.m4mQNDbSSRJYbKEDTIXWSAjW6K2ReUJQbA4q3xyxu0E';

        window.SupabaseClient = {
            async getLeads() {
                try {
                    const response = await fetch(`${SUPABASE_URL}/rest/v1/leads?order=created_at.desc`, {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const leads = await response.json();
                    
                    const today = new Date().toISOString().split('T')[0];
                    const stats = {
                        total_leads: leads.length,
                        new_leads: leads.filter(l => l.status === 'new').length,
                        today_leads: leads.filter(l => l.created_at?.startsWith(today)).length,
                        high_priority_leads: leads.filter(l => l.priority === 'high').length
                    };

                    return { success: true, leads: leads, stats: stats };
                } catch (error) {
                    console.error('Supabase error:', error);
                    return { success: false, error: error.message };
                }
            },

            async addLead(lead) {
                try {
                    const dbLead = {
                        name: lead.name,
                        phone: lead.phone,
                        email: lead.email || '',
                        vehicle: lead.vehicle || '',
                        year: lead.year || '',
                        make: lead.make || '',
                        model: lead.model || '',
                        vin: lead.vin || '',
                        condition: lead.condition || '',
                        has_title: lead.hasTitle || '',
                        damage: lead.damage || '',
                        location: lead.location || 'Miami',
                        zip: lead.zip || '',
                        comments: lead.comments || '',
                        status: 'new',
                        priority: 'high',
                        source: lead.source || 'Website Form'
                    };

                    const response = await fetch(`${SUPABASE_URL}/rest/v1/leads`, {
                        method: 'POST',
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=representation'
                        },
                        body: JSON.stringify(dbLead)
                    });

                    if (!response.ok) {
                        const error = await response.text();
                        throw new Error(`HTTP ${response.status}: ${error}`);
                    }

                    const savedLead = await response.json();
                    return { success: true, message: 'Lead saved to database', lead: savedLead[0] };
                } catch (error) {
                    console.error('Supabase error:', error);
                    return { success: false, error: error.message };
                }
            }
        };
        console.log('‚úÖ Supabase client loaded');
    </script>
    <script>
        // Login system
        const ADMIN_CREDENTIALS = {
            'admin': 'Miami2024!',
            'isaac': 'Miami2024!'
        };
        
        function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');
            
            // Check credentials
            if (ADMIN_CREDENTIALS[username] && ADMIN_CREDENTIALS[username] === password) {
                // Save login session
                sessionStorage.setItem('mjc_admin_logged_in', 'true');
                sessionStorage.setItem('mjc_admin_user', username);
                
                // Show admin panel
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'flex';
                document.querySelector('.mobile-menu-toggle').style.display = 'block';
                
                // Load initial data
                loadStats();
                
                console.log('‚úÖ Login successful');
            } else {
                errorDiv.textContent = '‚ùå Invalid username or password';
                errorDiv.style.display = 'block';
                document.getElementById('password').value = '';
            }
        }
        
        // Check if already logged in
        function checkLogin() {
            const isLoggedIn = sessionStorage.getItem('mjc_admin_logged_in');
            
            if (isLoggedIn === 'true') {
                // User has valid session, show admin panel
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'flex';
                document.querySelector('.mobile-menu-toggle').style.display = 'block';
                loadStats();
            } else {
                // No valid session, ensure login screen is visible
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('adminPanel').style.display = 'none';
                document.querySelector('.mobile-menu-toggle').style.display = 'none';
            }
        }
        
        // Logout function
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                sessionStorage.removeItem('mjc_admin_logged_in');
                sessionStorage.removeItem('mjc_admin_user');
                location.reload();
            }
        }
        
        // Check login on page load - CRITICAL: This enforces login
        window.addEventListener('DOMContentLoaded', checkLogin);
        
        // Mobile menu toggle
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('mobile-open');
        }
        
        // Close mobile menu when clicking outside
        document.addEventListener('click', function(e) {
            const sidebar = document.getElementById('sidebar');
            const toggle = document.querySelector('.mobile-menu-toggle');
            
            if (window.innerWidth <= 768 && 
                sidebar.classList.contains('mobile-open') &&
                !sidebar.contains(e.target) && 
                !toggle.contains(e.target)) {
                sidebar.classList.remove('mobile-open');
            }
        });
        
        // Close mobile menu when clicking a nav item
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    if (window.innerWidth <= 768) {
                        document.getElementById('sidebar').classList.remove('mobile-open');
                    }
                });
            });
        });
        
        let currentData = {
            leads: [],
            content: {},
            images: [],
            business: {},
            stats: {}
        };

        // Navigation
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                const section = item.dataset.section;
                showSection(section);
            });
        });

        function showSection(sectionName) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.querySelector(`[data-section="${sectionName}"]`).classList.add('active');
            document.getElementById(sectionName).classList.add('active');
            
            loadSectionData(sectionName);
        }

        // API calls
        async function apiCall(endpoint, data = null, method = 'GET') {
            const options = {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                }
            };
            
            if (data) {
                options.body = JSON.stringify(data);
            }
            
            try {
                const response = await fetch(`./database.php?${endpoint}`, options);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const text = await response.text();
                try {
                    return JSON.parse(text);
                } catch (parseError) {
                    console.error('Response not JSON:', text);
                    throw new Error('Invalid JSON response from server');
                }
            } catch (error) {
                console.error('Primary API failed, trying fallback:', error);
                
                // Try fallback API
                try {
                    const fallbackResponse = await fetch(`./fallback.php?${endpoint}`, options);
                    if (fallbackResponse.ok) {
                        const fallbackText = await fallbackResponse.text();
                        return JSON.parse(fallbackText);
                    }
                } catch (fallbackError) {
                    console.error('Fallback API also failed:', fallbackError);
                }
                
                return { success: false, error: error.message };
            }
        }

        // Load section data
        async function loadSectionData(section) {
            try {
                switch (section) {
                    case 'dashboard':
                        await loadStats();
                        break;
                    case 'leads':
                        await loadLeads();
                        break;
                    case 'content':
                        await loadContent();
                        break;
                    case 'images':
                        await loadImages();
                        break;
                    case 'business':
                        await loadBusiness();
                        break;
                }
            } catch (error) {
                console.error('Error loading section data:', error);
            }
        }

        // Load stats
        async function loadStats() {
            const result = await apiCall('action=stats');
            if (result.success) {
                currentData.stats = result.stats;
                document.getElementById('totalLeads').textContent = result.stats.total_leads;
                document.getElementById('newLeads').textContent = result.stats.new_leads;
                document.getElementById('todayLeads').textContent = result.stats.today_leads;
                document.getElementById('highPriorityLeads').textContent = result.stats.high_priority_leads;
            } else {
                // Fallback to localStorage/mock data
                loadMockStats();
            }
        }

        function loadMockStats() {
            const offlineLeads = JSON.parse(localStorage.getItem('mjc_offline_leads')) || [];
            const adminData = JSON.parse(localStorage.getItem('mjc_admin_data')) || { leads: [] };
            const totalLeads = offlineLeads.length + adminData.leads.length;
            
            document.getElementById('totalLeads').textContent = totalLeads;
            document.getElementById('newLeads').textContent = Math.floor(totalLeads * 0.7);
            document.getElementById('todayLeads').textContent = Math.floor(totalLeads * 0.1);
            document.getElementById('highPriorityLeads').textContent = Math.floor(totalLeads * 0.2);
        }

        // Load leads
        async function loadLeads() {
            const leadsTable = document.getElementById('leadsTable');
            leadsTable.innerHTML = '<div class="loading">Loading leads from database...</div>';
            
            // Try Supabase direct connection first (works everywhere!)
            if (window.SupabaseClient) {
                try {
                    console.log('üì° Loading from Supabase database...');
                    const result = await window.SupabaseClient.getLeads();
                    
                    if (result.success) {
                        currentData.leads = result.leads.map(lead => ({
                            ...lead,
                            created_at: lead.created_at || lead.timestamp
                        }));
                        
                        // Update stats
                        if (result.stats) {
                            document.getElementById('totalLeads').textContent = result.stats.total_leads;
                            document.getElementById('newLeads').textContent = result.stats.new_leads;
                            document.getElementById('todayLeads').textContent = result.stats.today_leads;
                            document.getElementById('highPriorityLeads').textContent = result.stats.high_priority_leads;
                        }
                        
                        renderLeadsTable();
                        console.log('‚úÖ Loaded from Supabase:', currentData.leads.length, 'leads');
                        return;
                    } else {
                        console.error('Supabase error:', result.error);
                    }
                } catch (error) {
                    console.error('Supabase failed:', error);
                }
            }
            
            // Fallback: Try API endpoints
            const endpoints = [
                '/api/leads',
                '/api/get-leads.php',
                '/admin/data/leads.json'
            ];
            
            for (const endpoint of endpoints) {
                try {
                    console.log(`üì° Trying ${endpoint}...`);
                    const response = await fetch(endpoint);
                    
                    if (response.ok && response.headers.get('content-type')?.includes('application/json')) {
                        const data = await response.json();
                        
                        let leads = [];
                        if (data.success && data.leads) {
                            leads = data.leads;
                        } else if (Array.isArray(data)) {
                            leads = data;
                        }
                        
                        if (leads.length >= 0) {
                            currentData.leads = leads.map(lead => ({
                                ...lead,
                                created_at: lead.timestamp || lead.created_at
                            }));
                            
                            if (data.stats) {
                                document.getElementById('totalLeads').textContent = data.stats.total_leads;
                                document.getElementById('newLeads').textContent = data.stats.new_leads;
                                document.getElementById('todayLeads').textContent = data.stats.today_leads;
                                document.getElementById('highPriorityLeads').textContent = data.stats.high_priority_leads;
                            } else {
                                updateStatsFromLeads(currentData.leads);
                            }
                            
                            renderLeadsTable();
                            console.log(`‚úÖ Loaded from ${endpoint}:`, currentData.leads.length, 'leads');
                            return;
                        }
                    }
                } catch (error) {
                    console.log(`‚ÑπÔ∏è ${endpoint} not available:`, error.message);
                }
            }
            
            // All methods failed - load from localStorage
            console.log('üì° Loading from localStorage...');
            loadOfflineLeads();
        }

        function loadOfflineLeads() {
            const offlineLeads = JSON.parse(localStorage.getItem('mjc_offline_leads')) || [];
            const adminData = JSON.parse(localStorage.getItem('mjc_admin_data')) || { leads: [] };
            const websiteLeads = JSON.parse(localStorage.getItem('mjc_website_leads')) || [];
            
            // Combine all leads from different sources
            const allLeads = [
                ...websiteLeads,
                ...offlineLeads,
                ...(adminData.leads || [])
            ].map((lead, index) => ({
                id: lead.id || index + 1,
                name: lead.name || 'Website Visitor',
                phone: lead.phone || 'Not provided',
                email: lead.email || 'Not provided',
                vehicle: lead.vehicle || `${lead.year || ''} ${lead.make || ''} ${lead.model || ''}`.trim() || 'Not specified',
                year: lead.year || '',
                make: lead.make || '',
                model: lead.model || '',
                vin: lead.vin || '',
                condition: lead.condition || '',
                location: lead.location || '',
                comments: lead.comments || '',
                priority: lead.priority || 'medium',
                status: lead.status || 'new',
                source: lead.source || 'Unknown',
                created_at: lead.created || lead.timestamp || new Date().toISOString()
            }));
            
            // Remove duplicates by phone number (keep first occurrence)
            const uniqueLeads = [];
            const seenPhones = new Set();
            
            allLeads.forEach(lead => {
                if (!seenPhones.has(lead.phone)) {
                    uniqueLeads.push(lead);
                    seenPhones.add(lead.phone);
                }
            });
            
            // Sort by date (newest first)
            uniqueLeads.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
            // Save cleaned website leads back to localStorage
            const cleanedWebsiteLeads = uniqueLeads.filter(lead => lead.source === 'Website Form');
            if (cleanedWebsiteLeads.length !== websiteLeads.length) {
                localStorage.setItem('mjc_website_leads', JSON.stringify(cleanedWebsiteLeads));
                console.log(`üßπ Cleaned up ${websiteLeads.length - cleanedWebsiteLeads.length} duplicate leads`);
            }
            
            currentData.leads = uniqueLeads;
            renderLeadsTable();
            
            // Update stats
            updateStatsFromLeads(uniqueLeads);
            
            if (uniqueLeads.length === 0) {
                // Show empty state
                document.getElementById('leadsTable').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox" style="font-size: 3rem; color: #cbd5e0; margin-bottom: 1rem;"></i>
                        <h3>No Leads Yet</h3>
                        <p>Leads from your website forms will appear here automatically.</p>
                        <p style="margin-top: 1rem; color: #718096;">
                            <small>Make sure your website forms are submitting correctly.</small>
                        </p>
                    </div>
                `;
            }
        }
        
        function updateStatsFromLeads(leads) {
            const today = new Date().toDateString();
            
            document.getElementById('totalLeads').textContent = leads.length;
            document.getElementById('newLeads').textContent = leads.filter(l => l.status === 'new').length;
            document.getElementById('todayLeads').textContent = leads.filter(l => {
                const leadDate = new Date(l.created_at);
                return leadDate.toDateString() === today;
            }).length;
            document.getElementById('highPriorityLeads').textContent = leads.filter(l => l.priority === 'high').length;
        }

        function renderLeadsTable() {
            const container = document.getElementById('leadsTable');
            
            if (currentData.leads.length === 0) {
                container.innerHTML = '<div class="empty-state">No leads found</div>';
                return;
            }

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Phone</th>
                            <th>Vehicle</th>
                            <th>Location</th>
                            <th>Source</th>
                            <th>Priority</th>
                            <th>Status</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            currentData.leads.forEach(lead => {
                const leadDate = new Date(lead.created_at);
                const formattedDate = leadDate.toLocaleDateString() + ' ' + leadDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                html += `
                    <tr>
                        <td>
                            <strong>${lead.name}</strong><br>
                            <small style="color: #6b7280;">${lead.email || 'No email'}</small>
                        </td>
                        <td><a href="tel:${lead.phone}" style="color: #10b981; text-decoration: none;">${lead.phone}</a></td>
                        <td>
                            <strong>${lead.vehicle || 'Not specified'}</strong><br>
                            ${lead.vin ? `<small style="color: #6b7280;">VIN: ${lead.vin}</small>` : ''}
                        </td>
                        <td>${lead.location || 'Miami'}</td>
                        <td><span style="font-size: 0.75rem; padding: 0.25rem 0.5rem; background: #e5e7eb; border-radius: 4px;">${lead.source || 'Unknown'}</span></td>
                        <td><span class="priority-${lead.priority}">${lead.priority.toUpperCase()}</span></td>
                        <td><span class="status-${lead.status}">${lead.status.toUpperCase()}</span></td>
                        <td><small>${formattedDate}</small></td>
                        <td>
                            <button class="btn btn-secondary btn-sm" onclick="viewLead('${lead.id}')" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <a href="tel:${lead.phone}" class="btn btn-primary btn-sm" title="Call" style="margin-left: 0.25rem;">
                                <i class="fas fa-phone"></i>
                            </a>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Load content
        async function loadContent() {
            const result = await apiCall('action=content');
            if (result.success) {
                currentData.content = result.content;
                renderContentEditor();
            } else {
                // Fallback: Parse actual website content
                await loadWebsiteContent();
            }
        }

        async function loadWebsiteContent() {
            try {
                // Fetch the main website page
                const response = await fetch('../index.html');
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                // Extract key content sections
                currentData.content = {
                    hero: {
                        title: doc.querySelector('h1')?.textContent || 'Buy Junk Car Miami',
                        content: doc.querySelector('.hero-content p')?.textContent || 'We buy junk cars in Miami for top dollar cash.',
                        meta_description: doc.querySelector('meta[name="description"]')?.content || 'Sell your junk car in Miami for cash today'
                    },
                    services: {
                        title: 'Our Services',
                        content: extractSectionContent(doc, 'services'),
                        meta_description: 'Professional junk car removal and cash buying services in Miami'
                    },
                    about: {
                        title: 'About Buy Junk Car Miami',
                        content: extractSectionContent(doc, 'about'),
                        meta_description: 'Learn about Miami\'s trusted junk car buyers'
                    },
                    contact: {
                        title: 'Contact Information',
                        content: `Phone: (305) 534-5991\nEmail: buyjunkcarmiami@gmail.com\nLicense: TI0105`,
                        meta_description: 'Contact Buy Junk Car Miami for immediate cash offers'
                    },
                    locations: {
                        title: 'Service Areas',
                        content: 'We serve Miami, Miami Beach, Coral Gables, Homestead, Hialeah, and surrounding areas',
                        meta_description: 'Junk car buying services throughout South Florida'
                    }
                };
                
                renderContentEditor();
                
            } catch (error) {
                console.error('Error loading website content:', error);
                // Load default content
                currentData.content = getDefaultContent();
                renderContentEditor();
            }
        }

        function extractSectionContent(doc, sectionId) {
            const section = doc.getElementById(sectionId) || doc.querySelector(`[data-section="${sectionId}"]`);
            if (section) {
                return section.textContent?.replace(/\s+/g, ' ').trim() || 'Content not found';
            }
            return 'Content not found';
        }

        function getDefaultContent() {
            return {
                hero: {
                    title: 'Buy Junk Car Miami',
                    content: 'Get instant cash for your junk car today! We buy all makes and models.',
                    meta_description: 'Miami\'s #1 junk car buyer - instant cash offers'
                },
                services: {
                    title: 'Our Services',
                    content: 'Fast cash offers, free towing, same-day pickup, licensed and insured',
                    meta_description: 'Professional junk car removal services in Miami'
                },
                about: {
                    title: 'About Us',
                    content: 'Buy Junk Car Miami is a licensed and trusted junk car buyer serving South Florida',
                    meta_description: 'Learn about Miami\'s premier junk car buying service'
                },
                contact: {
                    title: 'Contact',
                    content: 'Phone: (305) 534-5991\nEmail: buyjunkcarmiami@gmail.com\nLicense: TI0105',
                    meta_description: 'Contact information for Buy Junk Car Miami'
                },
                locations: {
                    title: 'Service Areas',
                    content: 'Miami, Miami Beach, Coral Gables, Homestead, Hialeah and all of South Florida',
                    meta_description: 'Areas served by Buy Junk Car Miami'
                }
            };
        }

        function renderContentEditor() {
            const container = document.getElementById('contentEditor');
            container.innerHTML = `
                <div class="form-group">
                    <label>Section</label>
                    <select id="contentSection" class="form-control" onchange="loadContentSection()">
                        <option value="">Select section to edit</option>
                        <option value="hero">Homepage Hero</option>
                        <option value="services">Services Section</option>
                        <option value="about">About Us</option>
                        <option value="contact">Contact Info</option>
                        <option value="locations">Locations</option>
                    </select>
                </div>
                <div id="contentFields" style="display:none;">
                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" id="contentTitle" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Content</label>
                        <textarea id="contentText" class="form-control" rows="6"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Meta Description</label>
                        <textarea id="contentMeta" class="form-control" rows="3"></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="saveContent()">
                        <i class="fas fa-save"></i> Save Content
                    </button>
                </div>
            `;
        }

        function loadContentSection() {
            const section = document.getElementById('contentSection').value;
            const fields = document.getElementById('contentFields');
            
            if (!section) {
                fields.style.display = 'none';
                return;
            }
            
            fields.style.display = 'block';
            
            if (currentData.content[section]) {
                document.getElementById('contentTitle').value = currentData.content[section].title || '';
                document.getElementById('contentText').value = currentData.content[section].content || '';
                document.getElementById('contentMeta').value = currentData.content[section].meta_description || '';
            } else {
                document.getElementById('contentTitle').value = '';
                document.getElementById('contentText').value = '';
                document.getElementById('contentMeta').value = '';
            }
        }

        async function saveContent() {
            const section = document.getElementById('contentSection').value;
            if (!section) return;

            const data = {
                action: 'update_content',
                section: section,
                title: document.getElementById('contentTitle').value,
                content: document.getElementById('contentText').value,
                meta_description: document.getElementById('contentMeta').value
            };

            try {
                const result = await apiCall('', data, 'POST');
                if (result.success) {
                    alert('Content updated successfully!');
                    await loadContent();
                } else {
                    alert('Error updating content: ' + result.error);
                }
            } catch (error) {
                alert('Error saving content');
            }
        }

        // Load business info
        async function loadBusiness() {
            const result = await apiCall('action=business');
            if (result.success) {
                currentData.business = result.business;
                renderBusinessForm();
            } else {
                // Fallback to default business info
                currentData.business = {
                    name: 'Buy Junk Car Miami',
                    phone: '(305) 534-5991',
                    email: 'buyjunkcarmiami@gmail.com',
                    address: '122 South Miami Avenue, Miami, FL 33130',
                    license: 'TI0105',
                    hours: 'Monday - Sunday: 8:00 AM - 6:00 PM'
                };
                renderBusinessForm();
            }
        }

        function renderBusinessForm() {
            const container = document.getElementById('businessForm');
            const business = currentData.business;
            
            container.innerHTML = `
                <div class="form-group">
                    <label>Business Name</label>
                    <input type="text" id="businessName" class="form-control" value="${business.name || ''}">
                </div>
                <div class="form-group">
                    <label>Phone Number</label>
                    <input type="tel" id="businessPhone" class="form-control" value="${business.phone || ''}">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="businessEmail" class="form-control" value="${business.email || ''}">
                </div>
                <div class="form-group">
                    <label>Address</label>
                    <textarea id="businessAddress" class="form-control" rows="3">${business.address || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>License Number</label>
                    <input type="text" id="businessLicense" class="form-control" value="${business.license || ''}">
                </div>
                <div class="form-group">
                    <label>Business Hours</label>
                    <textarea id="businessHours" class="form-control" rows="3">${business.hours || ''}</textarea>
                </div>
            `;
        }

        // Create new page
        async function createNewPage(event) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            const resultDiv = document.getElementById('pageCreationResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div style="padding: 1rem; background: #e0f2fe; border: 1px solid #0284c7; border-radius: 4px; color: #075985;">Creating page...</div>';
            
            try {
                const response = await fetch('/api/create-page.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    resultDiv.innerHTML = `
                        <div style="padding: 1rem; background: #d1fae5; border: 1px solid #10b981; border-radius: 4px; color: #065f46;">
                            <strong>‚úÖ Page created successfully!</strong><br>
                            <a href="${result.url}" target="_blank" style="color: #065f46; text-decoration: underline;">View page: ${result.url}</a>
                        </div>
                    `;
                    form.reset();
                } else {
                    throw new Error(result.error || 'Failed to create page');
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div style="padding: 1rem; background: #fee2e2; border: 1px solid #dc2626; border-radius: 4px; color: #991b1b;">
                        <strong>‚ùå Error:</strong> ${error.message}
                    </div>
                `;
            }
        }
        
        async function saveBusinessInfo() {
            const data = {
                action: 'update_business',
                name: document.getElementById('businessName').value,
                phone: document.getElementById('businessPhone').value,
                email: document.getElementById('businessEmail').value,
                address: document.getElementById('businessAddress').value,
                license: document.getElementById('businessLicense').value,
                hours: document.getElementById('businessHours').value
            };

            try {
                const result = await apiCall('', data, 'POST');
                if (result.success) {
                    alert('Business information updated successfully!');
                    await loadBusiness();
                } else {
                    alert('Error updating business info: ' + result.error);
                }
            } catch (error) {
                alert('Error saving business information');
            }
        }

        // Load images
        async function loadImages() {
            try {
                const response = await fetch('/api/get-images.php');
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        currentData.images = result.images;
                        renderImagesGrid();
                        console.log('‚úÖ Loaded images:', result.count);
                        return;
                    }
                }
            } catch (error) {
                console.error('Failed to load images:', error);
            }
            
            // Show error state
            document.getElementById('imagesGrid').innerHTML = '<div class="empty-state">Failed to load images</div>';
        }

        function renderImagesGrid() {
            const container = document.getElementById('imagesGrid');
            
            if (!currentData.images || currentData.images.length === 0) {
                container.innerHTML = '<div class="empty-state">No images found</div>';
                return;
            }

            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; padding: 1rem;">';
            
            currentData.images.forEach(image => {
                const sizeKB = Math.round(image.size / 1024);
                html += `
                    <div style="border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; background: white;">
                        <div style="aspect-ratio: 1; background: #f9fafb; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                            <img src="${image.path}" alt="${image.filename}" 
                                 style="width: 100%; height: 100%; object-fit: cover;"
                                 onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=padding:2rem;text-align:center;color:#9ca3af>Preview not available</div>'">
                        </div>
                        <div style="padding: 0.75rem;">
                            <div style="font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${image.filename}">
                                ${image.filename}
                            </div>
                            <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.5rem;">
                                ${sizeKB} KB ‚Ä¢ ${image.type.toUpperCase()}
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button onclick="copyImagePath('${image.path}')" class="btn btn-secondary" style="flex: 1; padding: 0.5rem; font-size: 0.75rem;">
                                    <i class="fas fa-copy"></i> Copy Path
                                </button>
                                <a href="${image.path}" target="_blank" class="btn btn-secondary" style="flex: 1; padding: 0.5rem; font-size: 0.75rem; text-decoration: none; text-align: center;">
                                    <i class="fas fa-external-link-alt"></i> View
                                </a>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function copyImagePath(path) {
            navigator.clipboard.writeText(path).then(() => {
                alert('Image path copied to clipboard: ' + path);
            }).catch(err => {
                console.error('Failed to copy:', err);
                prompt('Copy this path:', path);
            });
        }

        // Modal functions
        function showAddLeadModal() {
            document.getElementById('addLeadModal').style.display = 'block';
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
                // If it's a dynamically created modal, remove it from DOM
                if (modalId === 'viewLeadModal') {
                    modal.remove();
                }
            }
        }
        
        // View lead details
        window.viewLead = function(leadId) {
            const lead = currentData.leads.find(l => l.id == leadId);
            if (!lead) {
                alert('Lead not found');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'viewLeadModal';
            modal.style.display = 'block';
            
            const leadDate = new Date(lead.created_at);
            const formattedDate = leadDate.toLocaleDateString() + ' at ' + leadDate.toLocaleTimeString();
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 700px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3>Lead Details</h3>
                        <button onclick="closeModal('viewLeadModal')" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280;">&times;</button>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                        <div>
                            <h4 style="color: #6b7280; font-size: 0.875rem; margin-bottom: 0.5rem;">CONTACT INFORMATION</h4>
                            <p><strong>Name:</strong> ${lead.name}</p>
                            <p><strong>Phone:</strong> <a href="tel:${lead.phone}" style="color: #10b981;">${lead.phone}</a></p>
                            <p><strong>Email:</strong> ${lead.email || 'Not provided'}</p>
                            <p><strong>Location:</strong> ${lead.location || 'Miami'}</p>
                        </div>
                        
                        <div>
                            <h4 style="color: #6b7280; font-size: 0.875rem; margin-bottom: 0.5rem;">VEHICLE INFORMATION</h4>
                            <p><strong>Vehicle:</strong> ${lead.vehicle}</p>
                            ${lead.year ? `<p><strong>Year:</strong> ${lead.year}</p>` : ''}
                            ${lead.make ? `<p><strong>Make:</strong> ${lead.make}</p>` : ''}
                            ${lead.model ? `<p><strong>Model:</strong> ${lead.model}</p>` : ''}
                            ${lead.vin ? `<p><strong>VIN:</strong> ${lead.vin}</p>` : ''}
                            ${lead.condition ? `<p><strong>Condition:</strong> ${lead.condition}</p>` : ''}
                        </div>
                    </div>
                    
                    ${lead.comments ? `
                        <div style="margin-top: 1.5rem;">
                            <h4 style="color: #6b7280; font-size: 0.875rem; margin-bottom: 0.5rem;">COMMENTS</h4>
                            <p style="background: #f9fafb; padding: 1rem; border-radius: 6px;">${lead.comments}</p>
                        </div>
                    ` : ''}
                    
                    <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #e5e7eb;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                            <div>
                                <p style="color: #6b7280; font-size: 0.875rem;">Status</p>
                                <span class="status-${lead.status}">${lead.status.toUpperCase()}</span>
                            </div>
                            <div>
                                <p style="color: #6b7280; font-size: 0.875rem;">Priority</p>
                                <span class="priority-${lead.priority}">${lead.priority.toUpperCase()}</span>
                            </div>
                            <div>
                                <p style="color: #6b7280; font-size: 0.875rem;">Source</p>
                                <p><strong>${lead.source || 'Unknown'}</strong></p>
                            </div>
                        </div>
                        <p style="color: #6b7280; font-size: 0.875rem; margin-top: 1rem;">Submitted: ${formattedDate}</p>
                    </div>
                    
                    <div style="margin-top: 2rem; text-align: right; display: flex; gap: 0.5rem; justify-content: space-between;">
                        <button onclick="deleteLead('${lead.id}')" class="btn btn-danger">
                            <i class="fas fa-trash"></i> Delete Lead
                        </button>
                        <div style="display: flex; gap: 0.5rem;">
                            <a href="tel:${lead.phone}" class="btn btn-primary">
                                <i class="fas fa-phone"></i> Call Customer
                            </a>
                            ${lead.email ? `<a href="mailto:${lead.email}" class="btn btn-secondary">
                                <i class="fas fa-envelope"></i> Send Email
                            </a>` : ''}
                            <button onclick="closeModal('viewLeadModal')" class="btn btn-secondary">Close</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Close on background click
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeModal('viewLeadModal');
                }
            });
        };

        // Clear old localStorage leads
        window.clearOldLeads = async function() {
            const websiteLeads = JSON.parse(localStorage.getItem('mjc_website_leads')) || [];
            const offlineLeads = JSON.parse(localStorage.getItem('mjc_offline_leads')) || [];
            const adminData = JSON.parse(localStorage.getItem('mjc_admin_data')) || { leads: [] };
            
            const totalOldLeads = websiteLeads.length + offlineLeads.length + adminData.leads.length;
            
            if (totalOldLeads === 0) {
                alert('No old leads found in localStorage.');
                return;
            }
            
            const message = `Found ${totalOldLeads} old leads in localStorage:\n\n` +
                `‚Ä¢ Website leads: ${websiteLeads.length}\n` +
                `‚Ä¢ Offline leads: ${offlineLeads.length}\n` +
                `‚Ä¢ Admin leads: ${adminData.leads.length}\n\n` +
                `These are OLD leads not in your database.\n\n` +
                `Do you want to DELETE them?\n\n` +
                `‚ö†Ô∏è This will permanently remove them from localStorage.\n` +
                `Only leads in Supabase database will remain.`;
            
            if (!confirm(message)) {
                return;
            }
            
            // Clear all localStorage leads
            localStorage.removeItem('mjc_website_leads');
            localStorage.removeItem('mjc_offline_leads');
            localStorage.setItem('mjc_admin_data', JSON.stringify({ leads: [] }));
            
            alert(`‚úÖ Cleared ${totalOldLeads} old leads from localStorage.\n\nOnly database leads will now be shown.`);
            
            // Reload leads from database only
            await loadLeads();
            await loadStats();
        };
        
        // Delete lead function
        window.deleteLead = async function(leadId) {
            if (!confirm('Are you sure you want to delete this lead? This action cannot be undone.')) {
                return;
            }
            
            try {
                // Try to delete from Supabase first
                if (window.SupabaseClient) {
                    const response = await fetch(`${SUPABASE_URL}/rest/v1/leads?id=eq.${leadId}`, {
                        method: 'DELETE',
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    });
                    
                    if (response.ok) {
                        console.log('‚úÖ Deleted from Supabase');
                    }
                }
                
                // Remove from localStorage
                const websiteLeads = JSON.parse(localStorage.getItem('mjc_website_leads')) || [];
                const offlineLeads = JSON.parse(localStorage.getItem('mjc_offline_leads')) || [];
                const adminData = JSON.parse(localStorage.getItem('mjc_admin_data')) || { leads: [] };
                
                const filteredWebsite = websiteLeads.filter(l => l.id != leadId);
                const filteredOffline = offlineLeads.filter(l => l.id != leadId);
                const filteredAdmin = adminData.leads.filter(l => l.id != leadId);
                
                localStorage.setItem('mjc_website_leads', JSON.stringify(filteredWebsite));
                localStorage.setItem('mjc_offline_leads', JSON.stringify(filteredOffline));
                adminData.leads = filteredAdmin;
                localStorage.setItem('mjc_admin_data', JSON.stringify(adminData));
                
                // Close modal and refresh
                closeModal('viewLeadModal');
                alert('Lead deleted successfully!');
                await loadLeads();
                await loadStats();
                
            } catch (error) {
                console.error('Error deleting lead:', error);
                alert('Error deleting lead: ' + error.message);
            }
        };
        
        // Lead form submission
        document.getElementById('leadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = {
                action: 'add_lead',
                name: formData.get('name'),
                phone: formData.get('phone'),
                email: formData.get('email'),
                year: formData.get('year'),
                make: formData.get('make'),
                model: formData.get('model'),
                condition: formData.get('condition'),
                location: formData.get('location'),
                message: formData.get('message')
            };

            try {
                const result = await apiCall('', data, 'POST');
                if (result.success) {
                    alert('Lead added successfully!');
                    closeModal('addLeadModal');
                    e.target.reset();
                    await loadLeads();
                    await loadStats();
                } else {
                    alert('Error adding lead: ' + result.error);
                }
            } catch (error) {
                alert('Error adding lead');
            }
        });

        // Refresh data
        async function refreshData() {
            const currentSection = document.querySelector('.nav-item.active').dataset.section;
            await loadSectionData(currentSection);
            if (currentSection === 'dashboard') {
                await loadStats();
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadStats();
            loadLeads();
        });

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }
    </script>
</body>
</html>